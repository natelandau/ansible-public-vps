---
version: "3.9"

networks:
  default:
    driver: bridge
  traefik_proxy:
    name: traefik_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.90.0/24

services:
    traefik:
        image: "traefik:v{{ traefik_version }}"
        container_name: "traefik"
        environment:
            - "TZ=${TZ:?err}"
            - CF_API_EMAIL=${CF_API_EMAIL:?err}
            - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN:?err}
        command:
            - "--accesslog.filepath=/logs/access.log"
            - "--accesslog=true"
            - "--api.dashboard=true"
            - "--api=true"

            - "--entrypoints.websecure.address=:9091"
            - "--entrypoints.websecure.address=:443"
            - "--entrypoints.websecure.forwardedHeaders.trustedIPs={{ cloudflare_ip4_ips }}"

            - "--entrypoints.web.address=:80"
            - "--entrypoints.web.forwardedHeaders.trustedIPs={{ cloudflare_ip4_ips }}"
            - "--entryPoints.web.http.redirections.entrypoint.permanent=true"
            - "--entryPoints.web.http.redirections.entryPoint.scheme=https"
            - "--entryPoints.web.http.redirections.entryPoint.to=websecure"

            - "--global.sendAnonymousUsage=false"
            - "--global.checkNewVersion=false"

            - "--log.filePath=/logs/traefik.log"
            - "--log.level=WARN" # DEBUG, PANIC, FATAL, ERROR, WARN, and INFO.
            - "--log=true"

            - "--providers.docker.endpoint=unix:///var/run/docker.sock"
            - "--providers.docker.exposedbydefault=false"
            - "--providers.docker=true"
            - "--providers.file.directory=/rules"
            - "--providers.file.watch=true"

            - "--certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=10"
            - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
            - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
            - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
            - "--certificatesresolvers.letsencrypt.acme.email=${CF_API_EMAIL}"
            - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.traefik.rule=Host(`t.{{ domain_name }}`)"
            - "traefik.http.routers.traefik.entrypoints=web,websecure"
            - "traefik.http.routers.traefik.service=api@internal"
            - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
        networks:
            traefik_proxy:
                ipv4_address: 192.168.90.3
        ports:
            - target: 80
              published: 80
              protocol: tcp
              mode: host
            - target: 443
              published: 443
              protocol: tcp
              mode: host
            - target: 9091
              published: 9091
              protocol: tcp
              mode: host
        volumes:
            - "/var/run/docker.sock:/var/run/docker.sock:ro"
            - "{{ docker_dir }}/traefik/acme:/acme"
            - "{{ traefik_log_location }}:/logs"
            - "{{ docker_dir }}/traefik/.httpauth.txt:/.httpauth.txt:ro"
            - "{{ docker_dir }}/traefik/rules:/rules"
        restart: always
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.traefik.service=api@internal"
            - "traefik.http.routers.traefik.rule=Host(`t.{{ domain_name }}`)"
            - "traefik.http.routers.traefik.entrypoints=web,websecure"
            - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
            - "traefik.http.routers.traefik.middlewares=chain-basic-auth@file"

    whoami:
        image: "traefik/whoami"
        container_name: "whoami"
        networks:
            - traefik_proxy
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.whoami.rule=Host(`whoami.{{ domain_name }}`)"
            - "traefik.http.routers.whoami.entrypoints=web,websecure"
            - "traefik.http.routers.whoami.tls.certresolver=letsencrypt"
            - "traefik.http.routers.whoami.middlewares=chain-basic-auth@file"
